<!DOCTYPE html>
<html lang="en-gb">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://robinthrift.com/index.xml">
    <meta content="" name="keywords">
    <meta content="Metalsmith Part 3: Refining Our Tools - Robin Thrift" property="og:title">
    <title>Metalsmith Part 3: Refining Our Tools | Robin Thrift</title>
    <link rel="stylesheet" href="https://robinthrift.com/css/style.min.css">
</head>


<body>
  <section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://robinthrift.com/"><h1 class="title is-4">Robin Thrift</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/RobinThrift">
              <svg
                  width="24"
                  height="24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-label="github"
                >
                  <use xlink:href="/img/social.map.svg#github"/>
              </svg>
          </a>
          
          <a class="level-item" href="https://twitter.com/RobinThrift">
              <svg
                  width="24"
                  height="24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-label="twitter"
                >
                  <use xlink:href="/img/social.map.svg#twitter"/>
              </svg>
          </a>
          
          <a class="level-item" href="/index.xml">
              <svg
                  width="24"
                  height="24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-label="rss"
                >
                  <use xlink:href="/img/social.map.svg#rss"/>
              </svg>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

  <section class="section">
    <div class="container">
      <h2 class="subtitle is-6">April 17, 2014</h2>
      <h1 class="title">Metalsmith Part 3: Refining Our Tools</h1>
      
      <div class="content">
        

<p><a href="https://robinthrift.com/post/metalsmith-part-2-shaping-the-metal/">Last time</a> we took a dive into collections and Metalsmiths internals. This time we are going to refine our script and even develop our own little plugin.</p>

<p>Without wasting any time, let&rsquo;s get started!</p>

<h3 id="writing-plugins">Writing Plugins</h3>

<p>I am going to start this tutorial off with a little plugin, that will save us a time, and automate our build process further. In order to render our posts correctly, we have to set every posts template individually. As most posts will likely have the same template, this is a little unnecessary, and error prone. So let&rsquo;s change that.</p>

<p>Firstly a little reminder, how Metalsmith represents files internally:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s1">&#39;title&#39;</span><span class="o">:</span> <span class="s1">&#39;FROM_THE_TITLE_KEY&#39;</span><span class="p">,</span>
    <span class="s1">&#39;template&#39;</span><span class="o">:</span> <span class="s1">&#39;TEMPLATE_NAME&#39;</span><span class="p">,</span>
    <span class="s1">&#39;contents&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">Buffer</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="s1">&#39;mode&#39;</span><span class="o">:</span> <span class="s1">&#39;HEX_FILE_PERM_CODE&#39;</span>
<span class="p">}</span>
</code></pre></div>
<p>And Metalsmith passes an object with all the files to every function that is passed to <code>.use()</code>. But that&rsquo;s not all, Metalsmith also passes you the current Metalsmith instance and a function to call, when you&rsquo;re done, so a full plugin would look like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">plugin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="nx">metalsmith</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">files</span><span class="p">);</span>
    <span class="nx">done</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">Metalsmith</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">)</span>
    <span class="c1">//...
</span><span class="c1"></span>    <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">plugin</span><span class="p">)</span>
    <span class="c1">//...
</span></code></pre></div>
<div class="note--small">The object keys represent the file path.</div>

<p>As you can probably guess, this will simply log all the files to the console. Go ahead and try it, it will give you a feel about how Metalsmith works.</p>

<p>Before we go on, we should modify out plugin to return a function. This allows us to pass the plugin a configuration object (and use it multiple times with different configs):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">findTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="nx">metalsmith</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//...
</span><span class="c1"></span>        <span class="nx">done</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>We want our plugin to add a template key to our posts (if there is none), so we&rsquo;ll need to filter out our posts first. We will do so, by looping over the files list and use a regular expression to check if the file is a post:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">findTemplate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">pattern</span><span class="p">);</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="nx">metalsmith</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">_f</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="nx">file</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_f</span><span class="p">.</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">_f</span><span class="p">.</span><span class="nx">template</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">templateName</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">done</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div>
<p>We can now use the plugin as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">Metalsmith</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">)</span>
    <span class="c1">//...
</span><span class="c1"></span>    <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">findTemplate</span><span class="p">({</span>
        <span class="nx">pattern</span><span class="o">:</span> <span class="s1">&#39;posts&#39;</span><span class="p">,</span>
        <span class="nx">templateName</span><span class="o">:</span> <span class="s1">&#39;post.hbt&#39;</span>
    <span class="p">}))</span>
    <span class="c1">//...
</span></code></pre></div>
<div class="note--small">Don't forget to remove the template key from your posts!</div>

<h4 id="metalsmith-metadata">metalsmith.metadata()</h4>

<p>As you can see by the example above, each plugin is also passed the current metalsmith instance. This allows you to pass around, or set, global metadata. This includes things like the collections we created in the last tutorial, but also configuration. There&rsquo;s a plugin called <a href="https://github.com/segmentio/metalsmith-metadata">metalsmith-metadata</a> that loads extra config data from a file. You could use this to set things like the base URL, similar to Jekyll&rsquo;s <code>_config.yml</code>.</p>

<h4 id="a-note-error-handling">A Note Error Handling</h4>

<p>Metalsmith uses <a href="https://github.com/segmentio/ware">ware</a> to allow for the nice chaining syntax, however, this also means we need to adapt our error handling. Firstly, if an error occurs, we shouldn&rsquo;t just throw it, we should pass it to the <code>done()</code> function as the first parameter. Like so:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">//...
</span><span class="c1"></span><span class="nx">done</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Oh noes!&#39;</span><span class="p">));</span>
<span class="c1">//...
</span></code></pre></div>
<p>We can then catch the error in the <code>build()</code> method. To do so, we pass it a callback, which first parameter will be the error, if any (the second parameter is a list of all the files):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">//...
</span><span class="c1"></span>    <span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">});</span>
</code></pre></div>
<p>Now that we&rsquo;ve got that out of the way, let us continue improving our script!</p>

<h3 id="statics">Statics</h3>

<p>Most websites (even simple ones) will need some kind of static assets, like styles, scripts or fonts. We will get to preprocessing styles and scripts in a bit, but for now, we&rsquo;ll assume that we are using good ol&rsquo; CSS and plain, old, simple, non-fancy, unsexy, no-frills-no-spills, boring, not-named-after-a-beverage JavaScript.</p>

<p>To copy over these <em>exciting</em> files we will just add them to our <code>src/</code> directory.</p>

<pre><code>.
|– src/
    |– content/
    |– images/
    |– styles/
    |   |_ main.css
    |_ scripts/
        |_ main.js
|– templates/
|   |_ partials/
|– config.json
|– index.js
|_ package.json
</code></pre>

<p>That&rsquo;s it. Metalsmith will copy the files over, including the file structure. Done. <code>next()</code>!</p>

<h3 id="preprocessing">Preprocessing</h3>

<p>Now using plain CSS and JS is boring, SCSS and CoffeeScript are way more fun! At least, we&rsquo;ll pretend for now, because that&rsquo;s what we are going to set up now.
Firstly we will need to install the CS (<a href="https://github.com/joaoafrmartins/metalsmith-coffee">metalsmith-coffee</a>) and SCSS (<a href="https://github.com/stevenschobert/metalsmith-sass">metalsmith-sass</a>) plugins via npm:</p>

<pre><code>$ npm install --save-dev metalsmith-coffee metalsmith-sass
</code></pre>

<p>Then require them in your build script and add them to your chain (they will filter the files themselves):</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="c1">//...
</span><span class="c1"></span>    <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">sass</span><span class="p">({</span>
        <span class="nx">outputStyle</span><span class="o">:</span> <span class="s1">&#39;compressed&#39;</span>
    <span class="p">}))</span>
    <span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">coffee</span><span class="p">())</span>
<span class="c1">//...
</span></code></pre></div>
<p>Both plugins accept all the options their respective underlying plugins do. Check the docs, if in doubt.</p>

<h3 id="were-to-go-from-here">Were to go from here</h3>

<p>This time, we learnt, how to write out own little plugin and set up the rest of the &ldquo;basic&rdquo; plugins. I didn&rsquo;t include any styles here, as that would be beyond the scope of this tutorial, and with the static assets in place now, you can simply add them yourself.</p>

<p>From here, you can go anywhere with a little JavaScript, so next time I will show an example, of a more complex plugin and hopefully you will fully understand the Metalsmith ecosystem.</p>

<p>The full source code for this part of the tutorial can be found <a href="https://github.com/RobinThrift/metalsmith-tutorial/tree/END-OF-PART-3">here</a></p>

      </div>
    </div>
  </section>
  <section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/RobinThrift">Robin Thrift</a> 2019</p>
  </div>
</section>

</body>
</html>
